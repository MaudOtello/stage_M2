---
title: "Extraction (G & CHM)"
author: "Maud"
date: "2024-06-04"
output: word_document
---
Ce scripte est une reprise du document *Extraction.R* de T. Gaquiert avec les commentaires et test de M. Aubry-Kientz. L'objectif est de me faire la main et d'appliquer ses analyses à partir des données qui m'ont été fournies.

```{r environnement de travail, include = F}
setwd("C:/Users/Maud Otello/Documents/cours_r/Stage_M2/Cartographie")
```

```{r Packages}
library(tidyverse)
library(sf)
library(raster)
```

# Création des variables environnementales
## Placette
```{r importation des placettes, include = F}
Placettes <- st_read('RegenerationPlots.shp')
```

Nous disposons de deux types de coordonnées (CoordType) : Réels/Théoriques. La 'Réels' correspond aux coordonées ajustés par correction de pentes.
```{r CoordType}
# 2 types de coordonnées : Réels / Théoriques
unique(Placettes$CoordType) 

# selection des centres 'réels' sur la P1 / 6 /11
PlacettesP1_6_11 <- Placettes %>%
  filter(Plot %in% c(1,6,11)) %>% 
  filter(CoordType == 'RealCoord') 

# buffer 15m autour du centre des placettes
PlacettesP1_6_11_buffer <- st_buffer(PlacettesP1_6_11,15) 

# plot placettes
plot(st_geometry(PlacettesP1_6_11)) 

# plot placettes + buffer 15m
plot(st_geometry(PlacettesP1_6_11_buffer)) 

# remplacer WGS84 UTM 22N par RFGF95 UTM22N 
st_crs(PlacettesP1_6_11_buffer) <- st_crs(2972) 
```
Il faut remplacer WGS84 UTM 22N par RFGF95 UTM22N car bien que le CRS soit équivalents, tous les objets doivent avoir le même système de projection pour les différentes extractions.
L'information de localisation de chaque placette est contenue dans une donnée type point (géolocalisée). Nous allons définir l'environnement dans les 15m aux alentours du centre du subplot.

## Guyafor 2016 P1, P6, P11
```{r importation Guyafor, include = F}
P1 <- read.csv("~/cours_r/Stage_M2/ParacouP1AllYears.csv", comment.char="#")
P6 <- read.csv("~/cours_r/Stage_M2/ParacouP6AllYears.csv", comment.char="#")
P11 <- read.csv("~/cours_r/Stage_M2/ParacouP11AllYears.csv", comment.char="#")
```

Nous allons créer un jeu de donnée unique avec l'ensemble de ces données.
```{r Guyafor}
# Fusion des parcelles
Guyafor <- rbind(P1,P6,P11)

# Sélection de l'années 2016 et des individus vivant
P1_6_11_2016 <- Guyafor %>%
  filter(CensusYear==2016 & CodeAlive==1) %>%
  dplyr::select(idTree,Xutm,Yutm, Family,Genus,Species, CircCorr) %>% #drop columns
  st_as_sf(coords = c('Xutm', 'Yutm'), crs=2972) %>%# data.frame -> sf object 'POINT' avec crs RFGF95 UTM 22N
  dplyr::mutate(DBH=CircCorr/pi) %>% dplyr::mutate(ST=((((DBH/100)^2)*pi)/4)) # DBH en mètres pour une Surface Terrière en m2
```

Maintenant je dispose d'un jeu de données avec mes surfaces terrières par placettes.
Cette partie a été réalisé pour les individus avec un DBH > 10cm. Maintenant nous allons le faire sur les Juveniles (DBH< 10cm).

## Juveniles
```{r importation Juveniles, include = F}
Guyafor_Juveniles <- read.csv("~/cours_r/Stage_M2/2024ParacouJuveniles(v2).csv", sep=";", comment.char="#")
```


```{r Juveniles}
Juveniles <- Guyafor_Juveniles %>%
  filter(!is.na(Xutm) &
           Plot ==c(1,6,11) &
           CensusYear == 2016) %>%
  st_as_sf(coords = c("Xutm", "Yutm"), 
           crs = st_crs(2972))

# Sélection des centres 'réels' sur la P1 / 6 /11
PlacettesP1 <- Placettes %>%
  filter(Plot == 1 %>% 
  filter(CoordType == 'RealCoord') 

# Réajustement du crs
st_crs(PlacettesP1) <- st_crs(2972)

# buffer 5m autour du centre des placettes
PlacettesP1_buffer5m <- st_buffer(PlacettesP1,5) 

# Fusion des placettes aux Juveniles
test_inter <- st_intersection( PlacettesP1_buffer5m, Juveniles)

# Absence de doublon
length(test_inter$idTree) == length(unique(test_inter$idTree))

# vérifier qu'on ne "perde" pas d'arbres en route! (pour les autres parcelles et les autres années)
length(Juveniles$idTree)
```
Au niveau des vérifications, nous avons pu voir que bien que l'on ne retombe pas toujours exactement sur les mêmes nous restons dans les ordres de grandeur.

## Surface terrière
Maintenant nous allons calculer par placette la surface terrière

```{r Surface terrière}
# vérification des crs

# intersection
var_ST <- st_intersection(PlacettesP1_6_11_buffer, P1_6_11_2016) %>% 
  group_by(idRegePlot) %>%  # group by identifiant unique placette
  summarise(G = sum(ST), nombre_tiges = n()) %>% # summarise : somme Surface Terriere par placette (m2) et nombre de tiges dans le buffer de 15m
  st_drop_geometry() # Geometry inutile à présent, retour à un tibble
```
Maintenant nous disposons d'un jeu de données comprenant la surface terrière.

## Extraction CHM
A partir d'un raster nous cherchons à savoir l'environnement lumineux sur les 15m environnant le centre des placettes.

```{r fonction CHM}
# Création de la fonction de CHM
Extraction_raster <- function(Buffer_Placettes, raster, type_et_annee) {


median_buffer<- raster::extract(raster, Buffer_Placettes,fun=median , na.rm=T) %>% as.data.frame() 
names(median_buffer)[1] <- paste0('Median_', type_et_annee)


buffer_25<- raster::extract(raster, Buffer_Placettes,fun=function(x, na.rm){quantile(x, .25, na.rm=T)} )%>% as.data.frame()  # pour extraire des quantiles il faut creer une fonction de base
names(buffer_25)[1] <- paste0('Perc25_', type_et_annee)


buffer_75<- raster::extract(raster, Buffer_Placettes,fun=function(x, na.rm){quantile(x, .75, na.rm=T)} )%>% as.data.frame() 
names(buffer_75)[1] <- paste0('Perc75_', type_et_annee)

var_raster_placettes <- cbind(Buffer_Placettes,median_buffer, buffer_25 , buffer_75) %>%# tout est dans le bon ordre : cbind
  st_drop_geometry() # geometry n'a plus d'interet à partir de là

return(var_raster_placettes)
 
}
```
Une fois cette fonction créée nous pouvons l'appliquer
```{r exemple CHM}
# CHM 2016
CHM2016 <- raster('~/cours_r/Stage_M2/Cartographie/CHM_2016_P1_P6_P11_Paracou_RFGF95UTM22N.tif')


var_chm_2016_buffer_placettes <- Extraction_raster(Buffer_Placettes = PlacettesP1_6_11_buffer, raster = CHM2016, type_et_annee = 'CHM_2016')


# CHM 2004
CHM2004 <- raster('~/cours_r/Stage_M2/Cartographie/CHM_2004_P1_P6_P11_Paracou_RFGF95UTM22N.tif')

var_chm_2004_buffer_placettes <- Extraction_raster(Buffer_Placettes = PlacettesP1_6_11_buffer, raster = CHM2004, type_et_annee = 'CHM_2004')
```

## Assemblage
Comme tout a été réaliser nous allons venir joindre G & CHM puis les extraire en un fichier csv, afin de pouvoir l'utiliser sans avoir à faire tourner ce script.
```{r G & CHM}
# Fusion placette
RegePlots_varEnv<- left_join(var_ST, var_chm_2016_buffer_placettes %>%
                               dplyr::select(-c(Plot, Line, Column, CoordType)) , by='idRegePlot') %>%
  left_join(var_chm_2004_buffer_placettes %>%
              dplyr::select(-c(Plot, Line, Column, CoordType)) , by='idRegePlot')

# Extraction du tiddle
#write.csv(RegePlots_varEnv, file ="Var_lux(2004_2016).csv")
```

# CensusYear & Plot
Maintenant qu'il m'est aisément possible d'extraire des données et de les calculer. Il me faudrait un df où il m'est possible 